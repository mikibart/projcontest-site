generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
}

// ==================== USERS ====================
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String
  role          UserRole @default(CLIENT)
  avatarUrl     String?
  bio           String?
  portfolio     String?
  phone         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  contests          Contest[]         @relation("ContestOwner")
  proposals         Proposal[]
  practiceRequests  PracticeRequest[]
  assignedPractices PracticeRequest[] @relation("EngineerPractices")
  files             File[]
  notifications     Notification[]
  refreshTokens     RefreshToken[]
  payments          Payment[]

  // Reviews
  reviewsGiven      Review[]          @relation("ReviewsGiven")
  reviewsReceived   Review[]          @relation("ReviewsReceived")

  // Messages
  messagesSent      Message[]         @relation("MessagesSent")
  messagesReceived  Message[]         @relation("MessagesReceived")

  // Drafts & Portfolio
  draftContests     DraftContest[]
  portfolioProjects PortfolioProject[]
}

enum UserRole {
  CLIENT
  ARCHITECT
  ENGINEER
  ADMIN
}

// ==================== REFRESH TOKENS ====================
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ==================== CONTESTS ====================
model Contest {
  id              String        @id @default(cuid())
  title           String
  description     String
  brief           String?       @db.Text
  location        String
  category        Category
  budget          Float
  deadline        DateTime
  status          ContestStatus @default(OPEN)
  imageUrl        String?
  isFeatured      Boolean       @default(false)

  // Technical details
  mustHaves       String[]
  constraints     String[]
  deliverables    String[]

  // Owner
  clientId        String
  client          User          @relation("ContestOwner", fields: [clientId], references: [id])

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  proposals       Proposal[]
  files           File[]        @relation("ContestFiles")
  qaMessages      QAMessage[]
  payments        Payment[]
  reviews         Review[]
  messages        Message[]
  portfolioProject PortfolioProject?
}

enum Category {
  RESIDENTIAL
  COMMERCIAL
  INTERIOR
  URBAN
  CONCEPT
  OFFICE
  EXTERIOR
}

enum ContestStatus {
  DRAFT
  PENDING_APPROVAL
  OPEN
  EVALUATING
  CLOSED
  HIDDEN
}

// ==================== PROPOSALS ====================
model Proposal {
  id            String         @id @default(cuid())
  description   String?        @db.Text
  status        ProposalStatus @default(SUBMITTED)
  feedback      String?
  withdrawnAt   DateTime?      // If architect withdraws proposal

  // Relations
  contestId     String
  contest       Contest        @relation(fields: [contestId], references: [id], onDelete: Cascade)
  architectId   String
  architect     User           @relation(fields: [architectId], references: [id])
  files         File[]         @relation("ProposalFiles")
  messages      Message[]

  // Timestamps
  submittedAt   DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

enum ProposalStatus {
  SUBMITTED
  UNDER_REVIEW
  SELECTED
  WINNER
  REJECTED
  WITHDRAWN
}

// ==================== PRACTICE REQUESTS ====================
model PracticeRequest {
  id                  String              @id @default(cuid())
  type                PracticeType
  propertyType        String
  size                Float?
  location            String

  // Context
  isVincolato         Boolean             @default(false)
  hasOldPermits       Boolean             @default(false)
  interventionDetails String?             @db.Text

  // Contact
  contactName         String
  contactEmail        String
  contactPhone        String?

  // Status
  status              PracticeStatus      @default(PENDING_QUOTE)
  quoteAmount         Float?
  quoteCurrency       String              @default("EUR")
  quoteValidUntil     DateTime?
  quoteNotes          String?             @db.Text

  // Progress tracking
  progressPercent     Int                 @default(0)
  progressNotes       String?             @db.Text
  completedAt         DateTime?

  // Relations
  userId              String?
  user                User?               @relation(fields: [userId], references: [id])
  engineerId          String?
  engineer            User?               @relation("EngineerPractices", fields: [engineerId], references: [id])
  files               File[]              @relation("PracticeFiles")

  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

enum PracticeType {
  ACCESSO_ATTI
  CILA
  SCIA
  PDC
  SANATORIA
  CALCOLI_STRUTTURALI
  SISMICA
  COLLAUDO
  IMPIANTI_ELETTRICI
  IMPIANTI_TERMICI
  RINNOVABILI
  SICUREZZA
  DIREZIONE_LAVORI
  COMPUTO
  ANTINCENDIO
  ACUSTICA
  CATASTO
  APE
  CONSULENZA_GENERICA
}

enum PracticeStatus {
  PENDING_QUOTE
  QUOTE_SENT
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== FILES ====================
model File {
  id            String    @id @default(cuid())
  filename      String
  originalName  String
  mimeType      String
  size          Int
  url           String

  // Relations
  userId        String?
  user          User?     @relation(fields: [userId], references: [id])
  contestId     String?
  contest       Contest?  @relation("ContestFiles", fields: [contestId], references: [id])
  proposalId    String?
  proposal      Proposal? @relation("ProposalFiles", fields: [proposalId], references: [id])
  practiceId    String?
  practice      PracticeRequest? @relation("PracticeFiles", fields: [practiceId], references: [id])

  // Timestamps
  createdAt     DateTime  @default(now())
}

// ==================== Q&A MESSAGES ====================
model QAMessage {
  id          String    @id @default(cuid())
  question    String    @db.Text
  answer      String?   @db.Text
  authorName  String
  authorEmail String

  // Relations
  contestId   String
  contest     Contest   @relation(fields: [contestId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt   DateTime  @default(now())
  answeredAt  DateTime?
}

// ==================== NOTIFICATIONS ====================
model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  link      String?

  // Relations
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime         @default(now())
}

enum NotificationType {
  CONTEST_NEW_PROPOSAL
  CONTEST_WINNER
  CONTEST_DEADLINE
  CONTEST_QA_NEW
  CONTEST_QA_ANSWER
  PRACTICE_QUOTE
  PRACTICE_UPDATE
  PRACTICE_CLAIMED
  PRACTICE_COMPLETED
  REVIEW_RECEIVED
  MESSAGE_NEW
  SYSTEM
  PAYMENT_REQUIRED
  PAYMENT_RECEIVED
}

// ==================== PAYMENTS ====================
model Payment {
  id              String        @id @default(cuid())
  amount          Float
  currency        String        @default("EUR")
  status          PaymentStatus @default(PENDING)
  provider        PaymentProvider
  providerPaymentId String?     @unique
  providerOrderId   String?     @unique

  // Relations
  contestId       String
  contest         Contest       @relation(fields: [contestId], references: [id])
  userId          String
  user            User          @relation(fields: [userId], references: [id])

  // Metadata
  metadata        Json?

  // Timestamps
  createdAt       DateTime      @default(now())
  paidAt          DateTime?
  updatedAt       DateTime      @updatedAt
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  BANK_TRANSFER
}

// ==================== REVIEWS ====================
model Review {
  id          String      @id @default(cuid())
  rating      Int         // 1-5 stars
  comment     String?     @db.Text

  // Who is being reviewed
  revieweeId  String
  reviewee    User        @relation("ReviewsReceived", fields: [revieweeId], references: [id], onDelete: Cascade)

  // Who wrote the review
  reviewerId  String
  reviewer    User        @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)

  // Context (optional - linked to contest)
  contestId   String?
  contest     Contest?    @relation(fields: [contestId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([reviewerId, contestId]) // One review per reviewer per contest
}

// ==================== MESSAGES ====================
model Message {
  id          String      @id @default(cuid())
  content     String      @db.Text
  read        Boolean     @default(false)

  // Sender
  senderId    String
  sender      User        @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  // Receiver
  receiverId  String
  receiver    User        @relation("MessagesReceived", fields: [receiverId], references: [id], onDelete: Cascade)

  // Context (optional - linked to contest or proposal)
  contestId   String?
  contest     Contest?    @relation(fields: [contestId], references: [id], onDelete: SetNull)
  proposalId  String?
  proposal    Proposal?   @relation(fields: [proposalId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt   DateTime    @default(now())
}

// ==================== DRAFT CONTESTS ====================
model DraftContest {
  id              String    @id @default(cuid())
  title           String?
  description     String?
  brief           String?   @db.Text
  location        String?
  category        Category?
  budget          Float?
  deadline        DateTime?
  imageUrl        String?

  // Technical details
  mustHaves       String[]
  constraints     String[]
  deliverables    String[]
  styles          String[]

  // Current step in wizard
  currentStep     Int       @default(1)

  // Draft data as JSON for flexibility
  formData        Json?

  // Owner
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ==================== PORTFOLIO PROJECTS ====================
model PortfolioProject {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  category    Category
  location    String?
  year        Int?
  imageUrl    String?
  images      String[] // Additional images
  tags        String[]
  featured    Boolean  @default(false)

  // Owner
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Linked to won contest (optional)
  contestId   String?  @unique
  contest     Contest? @relation(fields: [contestId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
